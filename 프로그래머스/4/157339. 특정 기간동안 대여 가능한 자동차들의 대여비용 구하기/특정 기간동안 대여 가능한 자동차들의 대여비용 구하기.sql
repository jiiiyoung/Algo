-- 코드를 입력하세요

-- 2022.11.01 ~ 2022.11.30일동안 대여 가능한 차 ID
    # START_DATE, END_DATE가 저 기간 사이에 있는 경우
    # START_DATE < 22.11.01 AND END_DATE > 22.11.30.

WITH RENTAL_CAR AS (
    SELECT DISTINCT(CAR_ID)
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
    WHERE START_DATE BETWEEN '2022-11-01' AND '2022-11-30' OR 
    END_DATE BETWEEN '2022-11-01' AND '2022-11-30' OR
    (START_DATE < '2022-11-01' AND END_DATE > '2022-11-30')
),

-- 30일간 대여 금액이 50만원 이상, 200만원 미만인 자동차(차종이 세단 OR SUV인 차 중에서)
DISCOUNT_PLAN AS (
    SELECT *
    FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
    WHERE CAR_TYPE IN ('SUV' OR '세단') AND DURATION_TYPE LIKE '30%'
),

RENTAL_FEE AS (
    SELECT DISTINCT(C.CAR_ID), C.CAR_TYPE, ROUND(C.DAILY_FEE * (1 - D.DISCOUNT_RATE / 100) * 30) AS FEE
    FROM CAR_RENTAL_COMPANY_CAR C JOIN DISCOUNT_PLAN D ON C.CAR_TYPE = D.CAR_TYPE
    WHERE C.DAILY_FEE * (1 - D.DISCOUNT_RATE / 100) * 30 BETWEEN 500000 AND 2000000
)

-- 합쳐서 출력하기
SELECT CAR_ID, CAR_TYPE, FEE
FROM RENTAL_FEE
WHERE CAR_ID NOT IN (SELECT CAR_ID FROM RENTAL_CAR)
ORDER BY FEE DESC, CAR_TYPE ASC, CAR_ID DESC
;
